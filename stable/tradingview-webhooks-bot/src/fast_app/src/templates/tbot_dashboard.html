<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>PnL Dashboard</title>

    <!-- jQuery and jQuery UI -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <!-- DataTables CSS/JS -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css"
    />
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"
    ></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/static/img/favicon.ico" type="image/x-icon" />

    <!-- Moment.js Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>

    <link rel="stylesheet" href="/static/css/style.css" />
  </head>

  <body class="bg-gray-900 text-gray-200">
    <header
      class="bg-gray-800 text-gray-100 p-4 flex items-center sticky top-0 z-50 shadow-lg"
    >
      <h1 class="text-2xl font-bold">Trading Dashboard</h1>
      <div class="flex items-center gap-6 ml-auto">
        <ul class="nav-pills">
          <li class="nav-item">
            <a class="nav-link" href="https://tv.porenta.us/">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://tv.porenta.us/alerts">Alerts</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://tv.porenta.us/orders">Orders</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://tv.porenta.us/tbot">Tbot</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://tv.porenta.us/errors">Errors</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://portfolio.porenta.us/"
              >Portfolio</a
            >
          </li>
        </ul>
        <div class="flex items-center">
          <input type="checkbox" id="autoRefresh" class="mr-2" />
          <label for="autoRefresh">Auto‑refresh (30s)</label>
        </div>

        <button
          id="refreshBtn"
          class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition-colors flex items-center gap-2"
        >
          <span>Refresh Data</span>
          <span id="refreshSpinner" class="spinner hidden"></span>
        </button>
      </div>
    </header>
    <!-- BT Symbol Input -->
    <section class="max-w-6xl mx-auto mt-6 p-4 bg-gray-800 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-4 text-gray-100">
        BT Symbol Tradingview
      </h2>

      <!-- BT Symbol Input -->
      <div>
        <div class="flex justify-between items-center mb-2">
          <label
            for="symbol-search-bt"
            class="text-sm font-medium text-gray-300"
            >Stock Symbol</label
          >
          <div class="flex items-center" id="symbol-status-container-bt">
            <!-- Status badge inserted via JS -->
          </div>
        </div>
        <input
          id="symbol-search-bt"
          type="text"
          placeholder="Enter symbol..."
          class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ui-autocomplete-input"
          style="text-transform: uppercase"
          required
          autocomplete="off"
        />
      </div>
      <!-- Buttons -->
      <div class="flex gap-4">
        <button
          type="button"
          id="get-symbol-data-button"
          class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
        >
          Get Data
        </button>
        <button
          type="button"
          id="get-symbol-csv-data-button"
          class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors"
        >
          Get CSV Data
        </button>
        <button
          type="button"
          id="get-rvol"
          class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors"
        >
          Get RVOL Data
        </button>
      </div>
    </section>

    <section class="max-w-6xl mx-auto mt-6 p-4 bg-gray-800 rounded-lg shadow">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-100">Active Positions</h2>
        <button
          onclick="closeAllPositions()"
          id="closeAllBtn"
          class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Close All Positions
        </button>
      </div>
      <table id="portfolio-table" class="w-full"></table>
    </section>
    <section class="max-w-6xl mx-auto mt-6 p-4 bg-gray-800 rounded-lg shadow">
      <div class="flex justify-between items-center mb-4">
        <div class="max-w-5xl mx-auto">
          <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
            <!-- Header -->
            <div
              class="bg-gray-700 p-4 border-b border-gray-600 flex items-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-2"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
                <polyline points="16 7 22 7 22 13"></polyline>
              </svg>
              <h4 class="text-xl font-semibold text-white">
                Stock Order Entry
              </h4>
            </div>

            <h2 class="text-xl font-semibold text-gray-100 mb-4">
              Order Entry Details
            </h2>
            <div id="order-entry-content">
              <!-- Order details table will be injected here -->
            </div>

            <form id="order-form" class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-6">
                  <!-- Symbol Input -->
                  <div>
                    <div class="flex justify-between items-center mb-2">
                      <label
                        for="symbol-search"
                        class="text-sm font-medium text-gray-300"
                        >Stock Symbol</label
                      >
                      <div
                        class="flex items-center"
                        id="symbol-status-container"
                      >
                        <!-- Status badge inserted via JS -->
                      </div>
                    </div>
                    <input
                      id="symbol-search"
                      type="text"
                      placeholder="Enter symbol..."
                      class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ui-autocomplete-input"
                      style="text-transform: uppercase"
                      required
                      autocomplete="off"
                    />
                  </div>
                  <!-- Subscribe/Unsubscribe Buttons -->
                  <div class="flex gap-4">
                    <button
                      type="button"
                      id="subscribe-button"
                      class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
                    >
                      Subscribe
                    </button>
                    <button
                      type="button"
                      id="unsubscribe-button"
                      class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors"
                    >
                      Unsubscribe
                    </button>
                    <button
                      type="submit"
                      id="check-order-button"
                      class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors"
                    >
                      Check Order Parameters
                    </button>
                  </div>

                  <!-- Order Action -->
                  <div
                    class="bg-gray-900 p-4 rounded-lg border border-gray-700"
                    id="order-direction-block"
                  >
                    <label class="block text-sm font-medium text-gray-300 mb-3"
                      >Order Direction</label
                    >
                    <div class="flex gap-4">
                      <button
                        type="button"
                        id="buy-button"
                        class="toggle-button flex-1 py-3 rounded-lg cursor-pointer transition-all bg-green-600 text-white"
                        data-value="BUY"
                      >
                        Long
                      </button>
                      <button
                        type="button"
                        id="sell-button"
                        class="toggle-button flex-1 py-3 rounded-lg cursor-pointer transition-all bg-gray-800 text-gray-400 hover:bg-gray-700"
                        data-value="SELL"
                      >
                        Short
                      </button>
                    </div>
                    <!-- Hidden input to hold orderAction value -->
                    <input
                      type="hidden"
                      id="order-action"
                      name="orderAction"
                      value="BUY"
                    />

                    <!-- Bracket Order (Take Profit) Checkbox -->
                    <div class="flex items-center mt-4">
                      <input
                        type="checkbox"
                        id="take-profit-bracket"
                        name="takeProfitBool"
                        value="false"
                        class="h-4 w-4 rounded border-gray-600 bg-gray-800 text-blue-600 focus:ring-blue-500"
                      />
                      <label
                        for="take-profit-bracket"
                        class="ml-2 text-sm text-gray-300"
                        >Bracket Order (Take Profit)</label
                      >
                    </div>

                    <!-- Bracket Order (Market Order) Checkbox -->
                    <div class="flex items-center mt-4">
                      <input
                        type="checkbox"
                        id="market-order"
                        name="set_market_order"
                        value="true"
                        class="h-4 w-4 rounded border-gray-600 bg-gray-800 text-blue-600 focus:ring-blue-500"
                      />
                      <label
                        for="market-order"
                        class="ml-2 text-sm text-gray-300"
                        >Market Order Entry</label
                      >
                    </div>
                  </div>

                  <!-- Account Balance -->
                  <div>
                    <label
                      for="account-balance"
                      class="flex items-center text-sm font-medium text-gray-300 mb-2"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 mr-1 text-gray-400"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path
                          d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                        ></path>
                      </svg>
                      Account Balance
                    </label>
                    <input
                      type="number"
                      id="account-balance"
                      name="accountBalance"
                      value="7500"
                      step="0.01"
                      min="0"
                      class="form-input"
                    />
                  </div>
                  <!-- Add this to the left column, after Account Balance section -->
                  <div>
                    <label
                      for="bar-size-setting"
                      class="flex items-center text-sm font-medium text-gray-300 mb-2"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 mr-1 text-gray-400"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <rect
                          x="3"
                          y="4"
                          width="18"
                          height="18"
                          rx="2"
                          ry="2"
                        ></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                      </svg>
                      Bar Size Setting
                    </label>
                    <!-- Remove the input from inside the select and set a default selected option -->
                    <select
                      id="bar-size-setting"
                      name="barSizeSetting_web"
                      class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                      <optgroup label="Seconds">
                        <option value="5 secs">5 seconds</option>
                        <option value="10 secs">10 seconds</option>
                        <option value="15 secs" selected>15 seconds</option>
                        <option value="30 secs">30 seconds</option>
                      </optgroup>
                      <optgroup label="Minutes">
                        <option value="1 min">1 minute</option>
                        <option value="2 mins">2 minutes</option>
                        <option value="5 mins">5 minutes</option>
                      </optgroup>
                    </select>
                  </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                  <!-- Risk Management Section with Updated ATR Sliders -->
                  <div
                    class="bg-gray-900 p-4 rounded-lg border border-gray-700"
                  >
                    <div class="flex items-center justify-between mb-4">
                      <h3 class="text-sm font-medium text-gray-300">
                        Risk Management
                      </h3>
                      <div class="flex items-center text-xs text-gray-400">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-4 w-4 mr-1"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <circle cx="12" cy="12" r="10"></circle>
                          <line x1="12" y1="8" x2="12" y2="12"></line>
                          <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <span>Configure your risk parameters</span>
                      </div>
                    </div>
                    <div class="space-y-4">
                      <!-- Reward/Risk Ratio -->
                      <div class="slider-container">
                        <div class="flex justify-between">
                          <label
                            for="reward-risk-ratio"
                            class="text-xs font-medium text-gray-400"
                            >Reward/Risk Ratio</label
                          >
                          <span
                            class="text-xs text-blue-400"
                            id="reward-risk-display"
                            >2.0:1</span
                          >
                        </div>
                        <div id="reward-risk-slider" class="mt-2"></div>
                        <input
                          type="hidden"
                          id="reward-risk-ratio"
                          name="rewardRiskRatio"
                          value="1.0"
                        />
                      </div>

                      <!-- v-Stop ATR Factor -->
                      <div class="slider-container">
                        <div class="flex justify-between">
                          <label
                            for="vstop-atr-factor"
                            class="text-xs font-medium text-gray-400"
                            >v-Stop ATR Factor</label
                          >
                          <span
                            class="text-xs text-blue-400"
                            id="vstop-atr-factor-display"
                            >1.5</span
                          >
                        </div>
                        <div id="vstop-atr-factor-slider" class="mt-2"></div>
                        <input
                          type="hidden"
                          id="vstop-atr-factor"
                          name="vstopAtrFactor"
                          value="1.5"
                        />
                      </div>

                      <!-- Keltner Channel ATR Factor -->
                      <div class="slider-container">
                        <div class="flex justify-between">
                          <label
                            for="kc-atr-factor"
                            class="text-xs font-medium text-gray-400"
                            >Keltner Channel ATR Factor</label
                          >
                          <span
                            class="text-xs text-blue-400"
                            id="kc-atr-factor-display"
                            >2.0</span
                          >
                        </div>
                        <div id="kc-atr-factor-slider" class="mt-2"></div>
                        <input
                          type="hidden"
                          id="kc-atr-factor"
                          name="kcAtrFactor"
                          value="2.0"
                        />
                      </div>

                      <!-- Risk Percentage -->
                      <div class="slider-container">
                        <div class="flex justify-between">
                          <label
                            for="risk-percentage"
                            class="text-xs font-medium text-gray-400"
                            >Risk Percentage</label
                          >
                          <span
                            class="text-xs text-blue-400"
                            id="risk-percentage-display"
                            >1.0%</span
                          >
                        </div>
                        <div id="risk-percentage-slider" class="mt-2"></div>
                        <input
                          type="hidden"
                          id="risk-percentage"
                          name="riskPercentage"
                          value="1.0"
                        />
                      </div>
                    </div>
                  </div>

                  <!-- Stop Loss Type Section -->
                  <!-- Stop Loss Type Section with Manual Option -->
                  <div>
                    <label class="block text-sm font-medium text-gray-300 mb-3"
                      >Stop Loss Type</label
                    >
                    <div class="grid grid-cols-4 gap-2">
                      <button
                        type="button"
                        class="stop-type-button p-3 rounded-lg cursor-pointer transition-all bg-gray-800 text-gray-400 hover:bg-gray-700 text-sm"
                        data-value="kcStop"
                      >
                        Keltner Channels
                      </button>
                      <button
                        type="button"
                        class="stop-type-button p-3 rounded-lg cursor-pointer transition-all bg-gray-800 text-gray-400 hover:bg-gray-700 text-sm"
                        data-value="pivot"
                      >
                        Pivot Level
                      </button>
                      <button
                        type="button"
                        class="stop-type-button p-3 rounded-lg cursor-pointer transition-all bg-gray-800 text-gray-400 hover:bg-gray-700 text-sm"
                        data-value="manual"
                      >
                        Manual
                      </button>

                      <button
                        type="button"
                        class="stop-type-button p-3 rounded-lg cursor-pointer transition-all bg-blue-600 text-white text-sm"
                        data-value="vStop"
                      >
                        V-Stop
                      </button>
                    </div>
                    <!-- Hidden input to hold stopType value -->
                    <input
                      type="hidden"
                      id="stop-type"
                      name="stopType"
                      value="vStop"
                    />

                    <!-- Manual Stop Loss Input (hidden by default) -->
                    <div id="manual-stop-container" class="mt-4 hidden">
                      <label
                        for="manual-stop-loss"
                        class="block text-sm font-medium text-gray-300 mb-2"
                        >Manual Stop Loss ($)</label
                      >
                      <input
                        type="number"
                        id="manual-stop-loss"
                        class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter stop loss price"
                        step="0.01"
                        min="0"
                        onchange="this.value = parseFloat(this.value).toFixed(2)"
                      />
                    </div>
                  </div>

                  <!-- Action Buttons -->
                  <div class="flex flex-col gap-3 mt-6">
                    <button
                      type="submit"
                      id="submit-order-button"
                      class="submit-button w-full flex items-center justify-center px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors"
                    >
                      Place Buy Order
                    </button>
                    <button
                      type="button"
                      onclick="getDataButton()"
                      id="get-data-button"
                      class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded text-white transition-colors"
                    >
                      Refresh Market Data
                    </button>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>
    <section class="max-w-6xl mx-auto mt-6 p-4 bg-gray-800 rounded-lg shadow">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-100">Open Orders</h2>
        <button
          onclick="cancelAllOrders()"
          id="cancelAllBtn"
          class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded text-white transition-colors"
        >
          Cancel All Orders
        </button>
      </div>
      <table id="trades-table" class="w-full"></table>
    </section>

    <section class="max-w-6xl mx-auto mt-6 p-4 bg-gray-800 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-4 text-gray-100">Current P&L</h2>
      <div id="pnl-metrics" class="grid grid-cols-5 gap-5">
        <!-- PnL metric cards here -->
        <div class="bg-gray-700 p-4 rounded shadow text-center">
          <p class="text-gray-300">Total Unrealized P&L</p>
          <p class="text-xl" id="unrealizedPnL">Loading...</p>
        </div>
        <div class="bg-gray-700 p-4 rounded shadow text-center">
          <p class="text-gray-300">Total Realized P&L</p>
          <p class="text-xl" id="realizedPnL">Loading...</p>
        </div>
        <div class="bg-gray-700 p-4 rounded shadow text-center">
          <p class="text-gray-300">Total P&L</p>
          <p class="text-xl" id="dailyPnL">Loading...</p>
        </div>
        <div class="bg-gray-700 p-4 rounded shadow text-center">
          <p class="text-gray-300">Net Liquidation</p>
          <p class="text-xl" id="net_liquidation">Loading...</p>
        </div>
        <div class="bg-gray-700 p-4 rounded shadow text-center">
          <p class="text-gray-300">Buying Power</p>
          <p class="text-xl" id="buying_power">Loading...</p>
        </div>
        <div class="bg-gray-700 p-4 rounded shadow text-center">
          <p class="text-gray-300">Cash Balance</p>
          <p class="text-xl" id="settled_cash">Loading...</p>
        </div>
      </div>
      <!-- NEW: TradingView Widget -->

      <section class="max-w-6xl mx-auto mt-6 p-4 bg-gray-800 rounded-lg shadow">
        <div class="flex justify-between items-center mb-4">
          <!-- TradingView Widget BEGIN -->
          <div class="tradingview-widget-container">
            <div class="tradingview-widget-container__widget"></div>
            <div class="tradingview-widget-copyright">
              <a
                href="https://www.tradingview.com/"
                rel="noopener nofollow"
                target="_blank"
                ><span class="blue-text"
                  >Track all markets on TradingView</span
                ></a
              >
            </div>
            <script>
              async function updateTradingViewWidget() {
                // Try getting the symbol directly from the input field.
                let inputSymbol = $("#symbol-search-bt")
                  .val()
                  .trim()
                  .toUpperCase();
                // If no symbol is provided in the input, fall back on session storage or defaults.
                const tvSymbol =
                  inputSymbol || sessionStorage.getItem("tv_symbol") || "AAPL";
                const tvExchange =
                  sessionStorage.getItem("tv_exchange") || "NASDAQ";
                const symbolTV = `${tvExchange}:${tvSymbol}`;
                console.log("TradingView symbol:", symbolTV);

                // Select the tradingview widget container
                const container = document.querySelector(
                  ".tradingview-widget-container"
                );
                if (!container) return;

                // Remove any old widget script (inserted dynamically)
                const oldScript = container.querySelector(
                  "script[data-widget]"
                );
                if (oldScript) {
                  oldScript.remove();
                }

                // Create a new script element with the updated config
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.src =
                  "https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js";
                script.setAttribute("data-widget", "true");
                // Configure the widget with the new symbol
                script.innerHTML = JSON.stringify({
                  width: "1150",
                  height: "650",
                  symbol: symbolTV,
                  interval: "1",
                  timezone: "America/New_York",
                  theme: "dark",
                  style: "1",
                  locale: "en",
                  allow_symbol_change: true,
                  backgroundColor: "rgba(13, 13, 13, 1)",
                  studies: ["STD;EMA"],
                  support_host: "https://www.tradingview.com",
                });

                container.appendChild(script);
              }
            </script>
          </div>
        </div>
      </section>
      <section class="max-w-6xl mx-auto mt-6 p-4 bg-gray-800 rounded-lg shadow">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-100">
            <span id="volatility-scan-title">Market Volatility Matches</span>
            <span id="scan-symbol-symbol" class="ml-2 text-blue-400"></span>
          </h2>
          <div class="flex items-center gap-3">
            <span id="scan-info" class="text-sm text-gray-400"></span>
            <button
              id="scan-refresh-btn"
              class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition-colors"
            >
              Refresh Scan
            </button>
          </div>
        </div>

        <div id="scan-summary" class="mb-4 text-sm text-gray-300"></div>
        <table id="volatility-matches-table" class="w-full"></table>
      </section>

      <!-- TradingView Widget END -->

      <!-- Notification Toast -->
      <div id="notification" class="success">
        <span class="notification-icon">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </span>
        <span id="notification-message">Notification message</span>
      </div>
    </section>

    <section class="max-w-6xl mx-auto mt-6 p-4 bg-gray-800 rounded-lg shadow">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-100">Active Symbols</h2>
        <button
          onclick="unsubscribeAllSymbol()"
          id="unSubBtn"
          class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Cancel All Symbols
        </button>
      </div>
      <table id="symbol-table" class="w-full"></table>
    </section>

    <section class="max-w-6xl mx-auto mt-6 p-4 bg-gray-800 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-4 text-gray-100">Completed Orders</h2>
      <table id="order-table" class="w-full"></table>
    </section>

    <!-- Scripts -->
    <script>
      // ----------------------------------------------------------------------------
      // 1) CACHE LAYER FOR pnl data
      // ----------------------------------------------------------------------------
      let ibDataPromise = null;

      /**
       * Returns a Promise for the P&L payload.
       * Caches the first call until clearIbDataCache() is invoked.
       */
      async function fetchIbData() {
        if (!ibDataPromise) {
          ibDataPromise = fetchData("/api/pnl-data").catch((err) => {
            // clear cache on failure so next call will retry
            ibDataPromise = null;
            throw err;
          });
        }
        return ibDataPromise;
      }

      /**
       * Clears the cached promise.  Next fetchIbData() will re‑fetch.
       */
      async function clearIbDataCache() {
        ibDataPromise = null;
      }

      // Debug logging function to help troubleshoot
      function logDebug(message, data) {
        console.log(`🔍 DEBUG: ${message}`, data);
      }

      // Ensure DataTables is properly loaded
      function checkDataTablesLoaded() {
        if (typeof $.fn.DataTable !== "function") {
          console.error(
            "DataTables library not loaded! Make sure jQuery and DataTables are included."
          );
          return false;
        }
        return true;
      }
      // Function to auto refresh
      $("#autoRefresh").change(function () {
        if (this.checked) {
          window.dashboardRefreshInterval = setInterval(
            loadDashboardData,
            30_000
          );
        } else {
          clearInterval(window.dashboardRefreshInterval);
        }
      });

      // Enhanced version of getSymbolData to update the table

      async function getSymbolData(useCSV = false) {
        // Only check for symbol when not using CSV endpoint
        let symbol = $("#symbol-search-bt").val().trim().toUpperCase();
        const barSizeSetting_web = $("#bar-size-setting").val();
        if (!useCSV && !symbol) {
          showNotificationBt(
            "error",
            "Please enter a symbol symbol before subscribing."
          );
          return;
        }

        try {
          // Update UI to show loading state
          $("#scan-symbol-symbol").text(symbol || "");
          $("#scan-info").text("Loading data...");
          $("#scan-refresh-btn")
            .prop("disabled", true)
            .html('<span class="spinner"></span>');

          // Choose endpoint based on the button clicked
          const endpoint = useCSV ? "/tvscan" : "/tvscan_ib";
          // For CSV, send an empty payload since no parameters are needed.
          const payload = useCSV
            ? {}
            : { symbol: symbol, barSizeSetting_web: barSizeSetting_web };

          logDebug(
            `Fetching data for symbol: ${symbol} using endpoint: ${endpoint}`
          );
          const response_tvscan = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result_tvscan = await response_tvscan.json();
          logDebug("API response received:", result_tvscan);

          // Fetch contracts to update TradingView widget, remains unchanged
          const response_contract = await fetch("/get_contracts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              symbol: symbol,
              barSizeSetting_web: barSizeSetting_web,
            }),
          });
          const result_contract = await response_contract.json();
          console.log("result_contract", result_contract);
          try {
            sessionStorage.setItem("tv_symbol", result_contract.symbol);
            sessionStorage.setItem("tv_exchange", result_contract.exchange);
            await updateTradingViewWidget();
          } catch (widgetError) {
            console.error("Error updating TradingView widget:", widgetError);
          }

          if (result_tvscan.error) {
            showNotificationBt("error", `Error: ${result_tvscan.error}`);
            $("#scan-info").text("Failed to load data");
            return;
          }

          if (!$.fn.DataTable.isDataTable("#volatility-matches-table")) {
            initVolatilityMatchesTable();
          }
          const table = $("#volatility-matches-table").DataTable();
          logDebug(
            `Updating table with ${result_tvscan.matches?.length || 0} matches`
          );
          table.clear();
          if (result_tvscan.matches && result_tvscan.matches.length > 0) {
            table.rows.add(result_tvscan.matches);
          }
          table.draw();

          const scanSummary = `Analyzed ${
            result_tvscan.data_points || 0
          } data points from ${result_tvscan.time_range?.start || "N/A"} to ${
            result_tvscan.time_range?.end || "N/A"
          } | Found ${result_tvscan.matches_found || 0} volatility matches`;
          $("#scan-summary").text(scanSummary);
          $("#scan-info").text(`${result_tvscan.bar_size || ""} bars`);

          showNotificationBt(
            "success",
            `Found ${
              result_tvscan.matches_found || 0
            } volatility matches for ${symbol}`
          );
          $("#symbol-status-container").html(
            '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded-full mr-2">Subscribed</span>'
          );
        } catch (error) {
          console.error("Error getting symbol data:", error);
          showNotificationBt(
            "error",
            `Failed to load volatility data: ${error.message}`
          );
          $("#scan-info").text("Error loading data");
        } finally {
          $("#scan-refresh-btn").prop("disabled", false).text("Refresh Scan");
        }
      }

      // Initialize the volatility matches table with robust error handling
      function initVolatilityMatchesTable() {
        logDebug("Initializing volatility table");

        try {
          // Make sure DataTables is loaded
          if (!checkDataTablesLoaded()) return;

          // Check if the table element exists
          const tableElement = $("#volatility-matches-table");
          if (tableElement.length === 0) {
            console.error(
              "Table element #volatility-matches-table not found in the DOM"
            );
            return;
          }

          // Check if DataTable is already initialized on this element
          if ($.fn.DataTable.isDataTable("#volatility-matches-table")) {
            logDebug(
              "DataTable already initialized, destroying previous instance"
            );
            tableElement.DataTable().destroy();
          }

          // Initialize DataTable with clear configuration
          volatilityMatchesTable = tableElement.DataTable({
            columns: [
              { data: "datetime", title: "Time", width: "20%" },
              { data: "symbol", title: "Symbol", width: "20%" },
              {
                data: "open",
                title: "Open Price",
                render: (d) => formatCurrencyBt(d),
                width: "20%",
              },
              {
                data: "close",
                title: "Close Price",
                render: (d) => formatCurrencyBt(d),
                width: "20%",
              },
              {
                data: "volume",
                title: "Volume",
                render: function (data) {
                  if (data === null || data === undefined) return "-";

                  // Round to nearest whole number
                  const value = Math.round(data);

                  // Format with K for thousands and M for millions
                  if (value >= 1000000) {
                    return Math.round(value / 1000000) + "M";
                  } else if (value >= 1000) {
                    return Math.round(value / 1000) + "K";
                  } else {
                    return value.toString();
                  }
                },
                width: "20%",
              },
              {
                data: "change_pct",
                title: "Change %",
                render: function (data) {
                  const formatted = formatNumberBt(data) + "%";
                  const colorClass =
                    data > 0
                      ? "text-green-400"
                      : data < 0
                      ? "text-red-400"
                      : "text-gray-300";
                  return `<span class="${colorClass} font-bold">${formatted}</span>`;
                },
                width: "20%",
              },
              {
                data: null,
                title: "Price Move",
                render: function (data) {
                  // Calculate price difference
                  const diff = data.close - data.open;
                  const formatted = formatCurrencyBt(Math.abs(diff));
                  const colorClass =
                    diff > 0
                      ? "text-green-400"
                      : diff < 0
                      ? "text-red-400"
                      : "text-gray-300";
                  const direction = diff > 0 ? "↑" : diff < 0 ? "↓" : "-";
                  return `<span class="${colorClass} font-bold">${direction} ${formatted}</span>`;
                },
                width: "20%",
              },
            ],
            order: [[0, "desc"]], // Sort by datetime in descending order (newest first)
            pageLength: 10,
            responsive: true,
            language: {
              search: "Filter matches:",
              emptyTable: "No volatility matches found",
              zeroRecords: "No matches found - try another symbol",
              info: "Showing _START_ to _END_ of _TOTAL_ matches",
              infoEmpty: "No matches to show",
              paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Prev",
              },
            },
            dom: '<"flex flex-col sm:flex-row justify-between items-center"<"flex-1"l><"flex-1 text-right"f>>rtip',
            initComplete: function () {
              $(this.api().table().container()).addClass("dark-theme");
              logDebug("DataTable initialization complete");
            },
          });

          logDebug("DataTable initialization successful");
          return volatilityMatchesTable;
        } catch (error) {
          console.error("Error initializing DataTable:", error);
          // Create a basic table as fallback
          $("#volatility-matches-table").html(`
      <tr><th>Time</th><th>Open Price</th><th>Close Price</th><th>Change %</th><th>Price Move</th></tr>
      <tr><td colspan="5">Error loading table: ${error.message}</td></tr>
    `);
        }
      }
      // Utility formatting functions.
      const formatCurrencyBt = (value) => {
        if (value === null || value === undefined) return "-";
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
        }).format(value);
      };

      const formatNumberBt = (value) => {
        if (value === null || value === undefined) return "-";
        return new Intl.NumberFormat("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }).format(value);
      };

      // Make sure notification function exists
      function showNotificationBt(type, message) {
        console.log(`${type.toUpperCase()}: ${message}`);

        // Add simple notification if the notification element doesn't exist
        if ($("#notification").length === 0) {
          $("body").append(`
      <div id="notification" class="${type}" style="position:fixed; bottom:20px; right:20px; padding:10px 20px; 
        background:${
          type === "success"
            ? "#10B981"
            : type === "error"
            ? "#EF4444"
            : "#3B82F6"
        }; 
        color:white; border-radius:4px; z-index:9999; opacity:0; transition:opacity 0.3s;">
        ${message}
      </div>
    `);
          $("#notification").css("opacity", "1");
          setTimeout(() => $("#notification").css("opacity", "0"), 3000);
        } else {
          // Use existing notification element
          const notification = $("#notification");
          notification.removeClass("success error info").addClass(type);
          $("#notification-message").text(message);
          notification.addClass("show");

          // Hide notification after 3 seconds
          setTimeout(() => {
            notification.removeClass("show");
          }, 3000);
        }
      }

      // Initialize everything when document is ready

      $(document).ready(function () {
        console.log("Initializing dashboard with improved error handling...");

        // Set up global error handlers
        window.addEventListener("unhandledrejection", function (event) {
          console.error("Unhandled promise rejection:", event.reason);
          showError("An unexpected error occurred. Please refresh the page.");
        });

        window.addEventListener("error", function (event) {
          console.error("Global error:", event.error);
          showError("A JavaScript error occurred. Please refresh the page.");
        });

        // Initialize dashboard with better error handling
        initializeDashboard().catch((error) => {
          console.error("Failed to initialize dashboard:", error);
          showError("Failed to initialize dashboard. Please refresh the page.");
        });

        initVolatilityMatchesTable();

        $("#scan-refresh-btn")
          .off("click")
          .on("click", function () {
            logDebug("Refresh scan button clicked");
            getSymbolData();
          });

        $("#get-symbol-data-button")
          .off("click")
          .on("click", function () {
            logDebug("Get symbol data button clicked");
            getSymbolData();
          });
        $("#get-rvol")
          .off("click")
          .on("click", function () {
            logDebug("Get symbol data button clicked");
            getSymbolData();
          });

        // Updated click handler for CSV button
        $("#get-symbol-csv-data-button")
          .off("click")
          .on("click", function () {
            logDebug("Get CSV symbol data button clicked");
            getSymbolData(true);
          });

        // Initialize with default values if present
        const defaultSymbol = sessionStorage.getItem("tv_symbol");
        if (defaultSymbol) {
          logDebug(`Initializing with default symbol: ${defaultSymbol}`);
          $("#symbol-search-bt").val(defaultSymbol);
        }

        logDebug("Initialization complete");
      });
      console.log("Dashboard bug fixes loaded successfully");
      //getDataButton
      async function getDataButton() {
        try {
          const Symbol_refresh = subscribeSymbol();

          const result_contract_data = await Symbol_refresh.json();
          console.log("result_contract_data", result_contract_data);
          const results_data = await response.json();
          showModalMessage("Refreshed", {
            status: "success",
            results: results_data,
          });
        } catch (error) {
          console.error("Error canceling all orders:", error);
          showModalMessage("Error", { error: "Failed to cancel all orders." });
        }
        return loadDashboardData();
      }

      async function cancelAllOrders() {
        try {
          const requestOptions = {
            method: "GET",
            redirect: "follow",
          };

          const response = await fetch(
            "/api/cancel-all-orders",
            requestOptions
          );
          const results = await response.json();
          showModalMessage("Cancel All Orders Response", {
            status: "success",
            results: results,
          });
        } catch (error) {
          console.error("Error canceling all orders:", error);
          showModalMessage("Error", { error: "Failed to cancel all orders." });
        }
        return loadDashboardData();
      }
      async function cancelOrder(order) {
        try {
          console.log("Original order data:", order);

          // Format the request data directly without a wrapper key
          let requestData = {};

          if (order.contract && order.order) {
            requestData = {
              contract: order.contract,
              order: order.order,
              orderId: order.order.orderId,
              permId: order.order.permId,
            };
          } else if (
            Array.isArray(order) &&
            order.length > 0 &&
            order[0].contract
          ) {
            requestData = {
              contract: order[0].contract,
              order: order[0].order,
              orderId: order[0].order.orderId,
              permId: order[0].order.permId,
            };
          } else {
            requestData = {
              contract: order.contract || {},
              order: order.order || order,
              orderId: order.orderId || (order.order ? order.order.orderId : 0),
              permId: order.permId || (order.order ? order.order.permId : null),
            };
          }

          console.log("Formatted request data:", requestData);

          const response = await fetch("/api/cancel-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Cancel order request failed: ${errorText}`);
          }

          const result = await response.json();
          console.log("Cancel order response:", result);
          return result;
        } catch (error) {
          console.error("Error canceling order:", error);
          showError(`Failed to cancel order: ${error.message}`);
          throw error;
        }
      }

      // Update handleCancelOrder function to handle the data correctly
      async function handleCancelOrder(orderJson) {
        try {
          // orderJson is passed as a JSON string from the button's onclick
          let order;

          try {
            // Try to parse the JSON string
            order = JSON.parse(decodeURIComponent(orderJson));
          } catch (parseError) {
            console.error("Error parsing order JSON:", parseError);
            // If parsing fails, try using the raw object
            order = orderJson;
          }

          console.log("Canceling order:", order);

          // Call the cancelOrder function with the parsed data
          const result = await cancelOrder(order);

          if (result.status === "success") {
            // Show success notification
            const symbol =
              order.contract?.symbol || order[0]?.contract?.symbol || "Unknown";
            showSuccess(`Order for ${symbol} canceled successfully`);
          } else {
            // Show error notification
            showError(result.message || "Failed to cancel order");
          }

          await loadDashboardData(); // refresh data
        } catch (error) {
          console.error("Error in handleCancelOrder:", error);
          showError(`Failed to cancel order: ${error.message}`);
        }
      }
      // ==========
      // 1) Helpers
      // ==========

      // Global helper: updateMetric
      function updateMetric(elementId, value) {
        const element = document.getElementById(elementId);
        if (!element) return;
        const formattedValue = new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
          minimumFractionDigits: 2,
        }).format(value);
        element.textContent = formattedValue;
        element.classList.remove(
          "text-green-400",
          "text-red-400",
          "text-gray-300"
        );
        if (value > 0) {
          element.classList.add("text-green-400");
        } else if (value < 0) {
          element.classList.add("text-red-400");
        } else {
          element.classList.add("text-gray-300");
        }
        element.classList.add(
          "opacity-0",
          "transition-opacity",
          "duration-500"
        );
        setTimeout(() => element.classList.remove("opacity-0"), 50);
      }

      // API fetch wrapper with error handling.
      const fetchData = async (endpoint) => {
        try {
          const response = await fetch(endpoint);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return await response.json();
        } catch (error) {
          console.error(`Error fetching data from ${endpoint}:`, error);
          throw error;
        }
      };
      // ==========
      // 2) Tables
      // ==========

      // ============ DataTables Globals ============
      let portfolioTable;
      let contractTable;
      let tradeTable;

      // Utility formatting functions.
      const formatCurrency = (value) => {
        if (value === null || value === undefined) return "-";
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
        }).format(value);
      };

      const formatNumber = (value) => {
        if (value === null || value === undefined) return "-";
        return new Intl.NumberFormat("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }).format(value);
      };

      // ==========
      // 3) async functions
      // ==========

      // ================== Load/Refresh Functions ==================

      // Fixed loadPnLMetrics function
      async function loadPnLMetrics(payload) {
        try {
          // 1) Fetch the raw data (cached or fresh)
          const data = payload || (await fetchIbData());

          // 2) PnL metrics
          const pnlData = data.pnl || {
            unrealizedPnL: 0,
            realizedPnL: 0,
            dailyPnL: 0,
          };
          updateMetric("unrealizedPnL", pnlData.unrealizedPnL || 0);
          updateMetric("realizedPnL", pnlData.realizedPnL || 0);
          updateMetric("dailyPnL", pnlData.dailyPnL || 0);

          // 3) Net liquidation & buying power
          updateMetric("net_liquidation", data.net_liquidation || 0);
          updateMetric("buying_power", data.buying_power || 0);
          updateMetric("settled_cash", data.settled_cash || 0);

          // 4) Load portfolio table with the data
          await loadPortfolioTable(data);
        } catch (error) {
          console.error("Failed to load PnL data:", error);
          ["unrealizedPnL", "realizedPnL", "net_liquidation"].forEach((id) => {
            const el = document.getElementById(id);
            if (el) {
              el.textContent = "Error loading data";
              el.classList.add("text-red-400");
            }
          });
        }
      }

      // Fixed loadPortfolioTable function
      let portfolioTableInitialized = false;
      async function loadPortfolioTable(initialData) {
        try {
          // Use provided data if available, otherwise fetch it
          const data = initialData || (await fetchIbData());

          console.log("Portfolio data received:", data);

          // Get both data sources
          const positions = Array.isArray(data.positions) ? data.positions : [];
          const portfolioDb = Array.isArray(data.portfolio_db)
            ? data.portfolio_db
            : [];

          // Create a map of portfolio_db data for quick lookup by symbol
          const portfolioMap = new Map();
          portfolioDb.forEach((item) => {
            if (item.symbol) {
              portfolioMap.set(item.symbol, item);
            }
          });

          // Process positions - filter for non-zero positions and merge with portfolio_db data
          const mapped = positions
            .filter((pos) => {
              // Only include positions that are not zero
              return pos && pos.position !== 0;
            })
            .map((pos) => {
              // Get corresponding portfolio_db entry if it exists
              const portfolioData = portfolioMap.get(pos.symbol) || {};

              // Merge the data, preferring portfolio_db values for market data
              return {
                symbol: pos.symbol || "",
                secType: pos.secType || "",
                exchange: pos.exchange || portfolioData.exchange || "",
                currency: pos.currency || "USD",
                position: pos.position || 0,
                marketPrice: portfolioData.marketPrice || 0,
                marketValue: portfolioData.marketValue || 0,
                averageCost: pos.averageCost || portfolioData.averageCost || 0,
                unrealizedPNL: portfolioData.unrealizedPNL || 0,
                realizedPNL: portfolioData.realizedPNL || 0,
                account: pos.account || portfolioData.account || "",
                timestamp:
                  portfolioData.timestamp ||
                  pos.timestamp ||
                  new Date().toISOString(),
              };
            });

          console.log("Mapped positions for table:", mapped);

          // Only proceed if we have mapped data
          if (mapped.length === 0) {
            console.warn("No active positions to display");
            // Initialize empty table if no positions
            if ($.fn.DataTable.isDataTable("#portfolio-table")) {
              $("#portfolio-table").DataTable().clear().draw();
            }
            return;
          }

          // Initialize or update the portfolio table
          if ($.fn.DataTable.isDataTable("#portfolio-table")) {
            console.log(
              "Updating existing portfolio table with",
              mapped.length,
              "positions"
            );
            $("#portfolio-table").DataTable().clear().rows.add(mapped).draw();
          } else {
            console.log("Creating new portfolio table");
            portfolioTableInitialized = true;
            portfolioTable = $("#portfolio-table").DataTable({
              data: mapped,
              columns: [
                {
                  data: null,
                  title: "Actions",
                  render: function (data) {
                    return `<button onclick="handleClosePosition('${data.symbol}', ${data.position}, ${data.marketPrice})"
                  class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded text-white transition-colors">
                  Close
              </button>`;
                  },
                },
                { data: "symbol", title: "Symbol" },
                {
                  data: "position",
                  title: "Position",
                  render: (d) => parseFloat(d).toFixed(2),
                },
                {
                  data: "marketPrice",
                  title: "Market Price",
                  render: (d) => formatCurrency(d),
                },
                {
                  data: "marketValue",
                  title: "Market Value",
                  render: (d) => formatCurrency(d),
                },
                {
                  data: "averageCost",
                  title: "Average Cost",
                  render: (d) => formatCurrency(d),
                },
                {
                  data: "unrealizedPNL",
                  title: "Unrealized P&L",
                  render: function (d) {
                    const formatted = formatCurrency(d);
                    const colorClass =
                      d > 0
                        ? "text-green-400"
                        : d < 0
                        ? "text-red-400"
                        : "text-gray-300";
                    return `<span class="${colorClass}">${formatted}</span>`;
                  },
                },
                {
                  data: "realizedPNL",
                  title: "Realized P&L",
                  render: function (d) {
                    const formatted = formatCurrency(d);
                    const colorClass =
                      d > 0
                        ? "text-green-400"
                        : d < 0
                        ? "text-red-400"
                        : "text-gray-300";
                    return `<span class="${colorClass}">${formatted}</span>`;
                  },
                },
                {
                  data: "timestamp",
                  title: "Last Update",
                  render: (d) => new Date(d).toLocaleString(),
                },
              ],
              order: [[1, "asc"]],
              pageLength: 25,
              dom: '<"flex flex-col sm:flex-row justify-between items-center"<"flex-1"l><"flex-1 text-right"f>>rtip',
              responsive: true,
              language: { search: "Filter positions:" },
            });
          }

          console.log(
            "Portfolio table updated with",
            mapped.length,
            "positions"
          );
        } catch (error) {
          console.error("Failed to load portfolio data:", error);
          showError("Could not update portfolio table");
        }
      }

      async function loadOrdersTable(initialData) {
        try {
          // Get the raw data
          const data = initialData || (await fetchIbData());

          // FIX: Handle the nested trades structure correctly
          let trades = [];

          if (data.trades) {
            // Check if data.trades is an object with a 'trades' property (new structure)
            if (
              typeof data.trades === "object" &&
              data.trades.trades &&
              Array.isArray(data.trades.trades)
            ) {
              trades = data.trades.trades;
              console.log(
                "Using nested trades structure:",
                trades.length,
                "trades found"
              );
            }
            // Fallback: if data.trades is directly an array (old structure)
            else if (Array.isArray(data.trades)) {
              trades = data.trades;
              console.log(
                "Using direct trades array:",
                trades.length,
                "trades found"
              );
            }
            // Additional fallback: check for other possible properties
            else if (data.trades.orders && Array.isArray(data.trades.orders)) {
              trades = data.trades.orders;
              console.log(
                "Using orders array from trades:",
                trades.length,
                "trades found"
              );
            } else {
              console.warn("Unexpected trades data structure:", data.trades);
              trades = [];
            }
          } else {
            console.warn("No trades data found in response");
            trades = [];
          }

          // Filter out unwanted statuses - now with proper error handling
          const activeTrades = trades.filter((t) => {
            try {
              return (
                t &&
                t.orderStatus &&
                t.orderStatus.status &&
                !["Inactive", "Cancelled", "Filled"].includes(
                  t.orderStatus.status
                )
              );
            } catch (error) {
              console.warn("Error filtering trade:", t, error);
              return false;
            }
          });

          console.log(
            "Loading orders table with",
            activeTrades.length,
            "active trades from",
            trades.length,
            "total trades"
          );

          // Initialize or update the DataTable
          if (!$.fn.DataTable.isDataTable("#trades-table")) {
            tradeTable = $("#trades-table").DataTable({
              data: activeTrades,
              columns: [
                {
                  data: null,
                  title: "Actions",
                  orderable: false,
                  render: function (data) {
                    try {
                      const orderData = {
                        contract: data.contract || {},
                        order: data.order || {},
                        orderStatus: data.orderStatus || {},
                      };
                      const encoded = encodeURIComponent(
                        JSON.stringify(orderData)
                      );
                      return `<button onclick="handleCancelOrder('${encoded}')"
                         class="px-3 py-1 bg-red-500 hover:bg-red-600 rounded text-white text-sm">
                          Cancel
                        </button>`;
                    } catch (error) {
                      console.error("Error rendering cancel button:", error);
                      return '<span class="text-gray-500">N/A</span>';
                    }
                  },
                },
                {
                  data: "order.orderId",
                  title: "Order ID",
                  render: function (data) {
                    return data || "N/A";
                  },
                },
                {
                  data: "contract.symbol",
                  title: "Symbol",
                  render: function (data) {
                    return data || "N/A";
                  },
                },
                {
                  data: "order.action",
                  title: "Action",
                  render: function (data) {
                    if (!data) return "N/A";
                    const colorClass =
                      data.toLowerCase() === "buy"
                        ? "text-green-400"
                        : "text-red-400";
                    return `<span class="${colorClass}">${data}</span>`;
                  },
                },
                {
                  data: "order.orderType",
                  title: "Type",
                  render: function (data) {
                    return data || "N/A";
                  },
                },
                {
                  data: "order.totalQuantity",
                  title: "Quantity",
                  render: function (data) {
                    return data ? formatNumber(data) : "N/A";
                  },
                },
                {
                  data: null,
                  title: "Price",
                  render: function (row) {
                    try {
                      const o = row.order || {};
                      if (o.orderType === "LMT" && o.lmtPrice > 0) {
                        return formatCurrency(o.lmtPrice);
                      }
                      if (
                        (o.orderType === "STP" || o.orderType === "TRAIL") &&
                        o.auxPrice > 0
                      ) {
                        return formatCurrency(o.auxPrice);
                      }
                      return "Market";
                    } catch (error) {
                      console.error("Error rendering price:", error);
                      return "N/A";
                    }
                  },
                },
                {
                  data: "orderStatus.status",
                  title: "Status",
                  render: function (data) {
                    if (!data) return "N/A";
                    const colors = {
                      Active: "text-green-400",
                      Submitted: "text-blue-400",
                      PreSubmitted: "text-blue-300",
                    };
                    const colorClass = colors[data] || "text-gray-300";
                    return `<span class="${colorClass}">${data}</span>`;
                  },
                },
                {
                  data: "order.tif",
                  title: "TIF",
                  render: function (data) {
                    return data || "N/A";
                  },
                },
                {
                  data: "order.ocaGroup",
                  title: "OCA Group",
                  render: function (data) {
                    return data || "N/A";
                  },
                },
                {
                  data: "orderStatus.whyHeld",
                  title: "Why Held",
                  render: function (data) {
                    return data || "N/A";
                  },
                },
                {
                  data: null,
                  title: "Time",
                  render: function (row) {
                    try {
                      const log =
                        Array.isArray(row.log) && row.log.length > 0
                          ? row.log[0]
                          : null;
                      return log && log.time
                        ? new Date(log.time).toLocaleString()
                        : "N/A";
                    } catch (error) {
                      console.error("Error rendering time:", error);
                      return "N/A";
                    }
                  },
                },
              ],
              order: [[11, "desc"]], // Sort by time column
              pageLength: 10,
              responsive: true,
              language: {
                search: "Filter trades:",
                emptyTable: "No active orders found",
                zeroRecords: "No matching orders found",
              },
              drawCallback: function () {
                console.log(
                  "Orders table updated with",
                  this.api().data().length,
                  "rows"
                );
              },
            });
          } else {
            // Update existing table
            tradeTable.clear().rows.add(activeTrades).draw();
          }

          console.log(
            "Orders table updated successfully with",
            activeTrades.length,
            "trades"
          );
        } catch (error) {
          console.error("Failed to load trade data:", error);
          showError("Could not update orders table: " + error.message);

          // Initialize empty table if there's an error
          if (!$.fn.DataTable.isDataTable("#trades-table")) {
            $("#trades-table").DataTable({
              data: [],
              columns: [
                {
                  title: "Error loading orders",
                  data: null,
                  defaultContent: "Please refresh the page",
                },
              ],
            });
          }
        }
      }

      async function loadContractTable(payload) {
        try {
          const data = payload || (await fetchIbData());

          // Ensure positions and completed_orders exist
          const rawPositions = Array.isArray(data.positions)
            ? data.positions
            : [];
          let rawCompleted = data.completed_orders;

          // If completed_orders is not already an array, wrap it in one (unless it's null/undefined)
          if (rawCompleted != null) {
            rawCompleted = Array.isArray(rawCompleted)
              ? rawCompleted
              : [rawCompleted];
          } else {
            rawCompleted = [];
          }

          // 1) Filter out only positions where position === 0
          const zeroPositions = rawPositions
            .filter((pos) => typeof pos === "object" && pos.position === 0)
            .map((pos) => ({
              contract: { symbol: pos.symbol || "" },
              order: {},
              orderStatus: {},
              position: pos.position,
              averageCost: pos.average_cost != null ? pos.average_cost : 0,
              account: pos.account || "",
              timestamp: pos.timestamp || "",
            }));

          // 2) Map completed_orders into the same shape
          const completedRows = rawCompleted.map((co) => ({
            contract: co.contract || {},
            order: co.order || {},
            orderStatus: co.orderStatus || {},
            position: 0, // completed_orders don’t carry “position” by default
            averageCost: co.order?.averageCost || 0,
            account: co.order?.account || "",
            timestamp: co.orderStatus?.timestamp || "",
          }));

          // 3) Combine zero‐positions + completed_orders
          const rows = zeroPositions.concat(completedRows);

          // 4) Initialize or update the DataTable
          if ($.fn.DataTable.isDataTable("#order-table")) {
            $("#order-table").DataTable().clear().rows.add(rows).draw();
          } else {
            $("#order-table").DataTable({
              data: rows,
              columns: [
                { data: "contract.symbol", title: "Symbol" },
                {
                  data: "position",
                  title: "Position",
                  render: (d) => (d != null ? parseFloat(d).toFixed(2) : ""),
                  defaultContent: "",
                },
                {
                  data: "order.action",
                  title: "Action",
                  defaultContent: "",
                },
                {
                  data: "order.totalQuantity",
                  title: "Quantity",
                  render: (d) => (d != null ? parseFloat(d).toFixed(2) : ""),
                  defaultContent: "",
                },
                {
                  data: "order.orderType",
                  title: "Order Type",
                  defaultContent: "",
                },
                {
                  data: "orderStatus.status",
                  title: "Status",
                  render: (d) => d || "",
                  defaultContent: "",
                },
                {
                  data: null,
                  title: "Limit / Stop Price",
                  render: (row) => {
                    const o = row.order || {};
                    if (o.orderType === "LMT" && o.lmtPrice > 0) {
                      return `$${o.lmtPrice.toFixed(2)}`;
                    }
                    if (
                      (o.orderType === "STP" || o.orderType === "TRAIL") &&
                      o.auxPrice > 0
                    ) {
                      return `$${o.auxPrice.toFixed(2)}`;
                    }
                    return "";
                  },
                  defaultContent: "",
                },
                {
                  data: "averageCost",
                  title: "Avg Cost",
                  render: (d) =>
                    d != null ? `$${parseFloat(d).toFixed(2)}` : "",
                  defaultContent: "",
                },
                {
                  data: "account",
                  title: "Account",
                  defaultContent: "",
                },
                {
                  data: "timestamp",
                  title: "Timestamp",
                  render: (d) => (d ? new Date(d).toLocaleString() : ""),
                  defaultContent: "",
                },
              ],
              order: [[0, "asc"]],
              pageLength: 10,
              responsive: true,
              language: { search: "Filter orders:" },
            });
          }
        } catch (error) {
          console.error("Failed to load order table:", error);
          showError("Could not update order table");
        }
      }

      // Dashboard initialization.

      async function initializeDashboard() {
        try {
          console.log("Initializing dashboard data...");
          // fetch everything once
          const freshData = await fetchIbData();

          // load metrics & tables in sequence
          await loadPnLMetrics(freshData);
          await loadPortfolioTable(freshData);
          await loadOrdersTable(freshData);
          await loadContractTable(freshData);
          await getActiveSymbols();

          console.log("Dashboard initialized with all tables");

          // bind ONLY the header refresh button
          $("#refreshBtn")
            .off("click")
            .on("click", async () => {
              const spinner = $("#refreshSpinner");
              spinner.removeClass("hidden");
              await loadDashboardData();
              spinner.addClass("hidden");
            });
        } catch (error) {
          console.error("Error initializing dashboard:", error);
          showError("Failed to initialize dashboard");
        }
      }

      async function loadDashboardData() {
        try {
          console.log("Loading dashboard data...");

          // Clear cache and show loading state
          await clearIbDataCache();

          // Show loading indicators
          const refreshBtn = $("#refreshBtn");
          const spinner = $("#refreshSpinner");

          if (refreshBtn.length) refreshBtn.prop("disabled", true);
          if (spinner.length) spinner.removeClass("hidden");

          try {
            // Fetch fresh data with timeout
            const fetchPromise = fetchIbData();
            const timeoutPromise = new Promise((_, reject) => {
              setTimeout(() => reject(new Error("Request timeout")), 10000);
            });

            const freshData = await Promise.race([
              fetchPromise,
              timeoutPromise,
            ]);

            console.log("Dashboard data loaded successfully");

            // Update all components with better error isolation
            const updatePromises = [
              loadPnLMetrics(freshData).catch((error) => {
                console.error("Error updating P&L metrics:", error);
                showError("Failed to update P&L metrics");
              }),
              loadPortfolioTable(freshData).catch((error) => {
                console.error("Error updating portfolio table:", error);
                showError("Failed to update portfolio table");
              }),
              loadOrdersTable(freshData).catch((error) => {
                console.error("Error updating orders table:", error);
                showError("Failed to update orders table");
              }),
              loadContractTable(freshData).catch((error) => {
                console.error("Error updating contracts table:", error);
                showError("Failed to update contracts table");
              }),
              getActiveSymbols().catch((error) => {
                console.error("Error updating active symbols:", error);
                showError("Failed to update active symbols");
              }),
            ];

            // Wait for all updates to complete (or fail)
            await Promise.allSettled(updatePromises);

            console.log("All dashboard components updated");
          } catch (fetchError) {
            console.error("Error fetching dashboard data:", fetchError);
            showError("Failed to fetch dashboard data: " + fetchError.message);
          }
        } catch (error) {
          console.error("Error in loadDashboardData:", error);
          showError("Failed to refresh dashboard data: " + error.message);
        } finally {
          // Always re-enable controls
          const refreshBtn = $("#refreshBtn");
          const spinner = $("#refreshSpinner");

          if (refreshBtn.length) refreshBtn.prop("disabled", false);
          if (spinner.length) spinner.addClass("hidden");
        }
      }

      // ================
      // 5) Close Actions
      // ================
      function showSuccess(message) {
        const toast = $(
          `<div class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">${message}</div>`
        );
        $("body").append(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      function showError(message) {
        // Create or update error notification
        const errorId = "error-" + Date.now();
        const errorHtml = `
    <div id="${errorId}" class="fixed bottom-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
          </svg>
          <span class="text-sm font-medium">${message}</span>
        </div>
        <button onclick="document.getElementById('${errorId}').remove()" class="ml-4 text-white hover:text-gray-200">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
  `;

        $("body").append(errorHtml);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          const errorElement = document.getElementById(errorId);
          if (errorElement) {
            errorElement.remove();
          }
        }, 5000);

        console.error("Dashboard Error:", message);
      }

      async function handleClosePosition(symbol, position, price) {
        const button = $(
          `button[onclick="handleClosePosition('${symbol}', ${position}, ${price})"]`
        );
        button.prop("disabled", true).html('<span class="spinner"></span>');

        try {
          const positions = await fetchIbData().then(
            (data) => data.positions || []
          );
          const direction = position > 0 ? "SELL" : "BUY";
          const timestamp = Math.floor(Date.now() / 1000); // Current Unix timestamp in seconds

          const quantity = position;

          const orderAction = position > 0 ? "SELL" : "BUY";

          const barSizeSetting_web = $("#bar-size-setting").val();

          const requestBody = {
            symbol: symbol,
            barSizeSetting_web: barSizeSetting_web,
            limit_price: price,
            rewardRiskRatio: parseFloat($("#reward-risk-ratio").val()),
            atrFactor: 1.5, // Default value, can be adjusted
            vstopAtrFactor: parseFloat($("#vstop-atr-factor").val()),
            kcAtrFactor: parseFloat($("#kc-atr-factor").val()),
            riskPercentage: parseFloat($("#risk-percentage").val()),
            accountBalance: parseFloat($("#account-balance").val()),
            orderAction: "close_all",
            quantity: Math.abs(position),
            stopType: "vStop",
            takeProfitBool: $("#take-profit-bracket").val() === "true",
            set_market_order: $("#market-order").val() === "true",
            stop_loss: 0.0, // Default value, will be overridden for manual stop types
            uptrend: false, // Assuming uptrend is a boolean property in positions
          };

          await fetch("/close_positions", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestBody),
          });

          showSuccess(`Position in ${symbol} closed successfully`);
          await loadDashboardData(); // refresh portfolio
        } catch (error) {
          console.error("Error closing position:", error);
          showError(`Failed to close position in ${symbol}`);
        } finally {
          button.prop("disabled", false).text("Close");
        }
      }
      // Prevent form submission via Enter key for the order form
      document
        .getElementById("order-form")
        .addEventListener("keydown", function (event) {
          if (event.key === "Enter") {
            event.preventDefault();
          }
        });

      let SymbolData = [],
        SymbolList = [],
        SymbolMap = {};

      $.getJSON("/symbols/")
        .done((data) => {
          SymbolData = data;
          // build your flat list + map
          SymbolList = [];
          SymbolMap = {};
          SymbolData.forEach((t) => {
            SymbolList.push(t.symbol);
            SymbolMap[t.symbol] = t.name;
          });
          // only now initialize your autocomplete
          initSymbolAutocomplete("#symbol-search");
          initSymbolAutocomplete("#symbol-search-bt");
        })
        .fail(() => console.error("Failed to fetch symbol data."));

      // Utility Functions
      function jsonToHtml(obj) {
        if (typeof obj === "object" && obj !== null && !Array.isArray(obj)) {
          let html = '<ul style="list-style-type:none; padding-left:1em;">';
          for (const key in obj) {
            html += `<li><strong>${key}:</strong> ${jsonToHtml(obj[key])}</li>`;
          }
          html += "</ul>";
          return html;
        } else if (Array.isArray(obj)) {
          let html = '<ul style="list-style-type:disc; padding-left:1.5em;">';
          for (const item of obj) {
            html += `<li>${jsonToHtml(item)}</li>`;
          }
          html += "</ul>";
          return html;
        } else {
          return String(obj);
        }
      }

      function showModalMessage(title, jsonData) {
        // Get the header container
        const headerContainer = $(
          ".bg-gray-700.p-4.border-b.border-gray-600.flex.items-center"
        );

        // Get the content container for symbol details
        const contentContainer = $("#order-entry-content");

        // Determine status color based on jsonData
        let statusColor = "text-blue-400"; // default info color
        if (jsonData.status === "success") {
          statusColor = "text-green-400";
        } else if (jsonData.status === "error" || jsonData.error) {
          statusColor = "text-red-400";
        }

        // Save the original SVG for reuse
        const originalSvg = headerContainer.find("svg").clone();

        // Clear previous content and add back the SVG
        headerContainer.empty();
        headerContainer.append(originalSvg);

        // Add the title with proper formatting
        headerContainer.append(
          `<h4 class="text-xl font-semibold ${statusColor}">${title}</h4>`
        );

        // Create content for the order-entry-content section
        contentContainer.empty();

        // If we have snapshot data, display it nicely
        if (jsonData.snapshot) {
          const snapshot = jsonData.snapshot;
          const SymbolInfo = jsonData.Symbol_info || {};

          // Create the content with snapshot data
          const contentHtml = `
      <div class="bg-gray-800 rounded-lg shadow p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
          <div class="flex items-center">
            <span class="text-2xl font-bold">${
              SymbolInfo.symbol || "Unknown"
            }</span>
            <span class="ml-2 px-2 py-0.5 text-xs rounded-full ${
              SymbolInfo.uptrend ? "bg-green-600" : "bg-red-600"
            } text-white">
              ${SymbolInfo.uptrend ? "Uptrend" : "Downtrend"}
            </span>
          </div>
          <div class="text-sm text-gray-400">${new Date().toLocaleTimeString()}</div>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mt-2">
          <!-- Market Data Panel -->
          <div class="bg-gray-900 p-3 rounded">
            <h5 class="text-sm text-gray-400 font-medium mb-2">Market Data</h5>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <span class="text-xs text-gray-500">Last:</span>
                <span class="text-lg font-semibold ml-1">${formatCurrency(
                  snapshot.last
                )}</span>
              </div>
              <div>
                <span class="text-xs text-gray-500">Bid/Ask:</span>
                <span class="ml-1">${formatCurrency(
                  snapshot.bid
                )}/${formatCurrency(snapshot.ask)}</span>
              </div>
              <div>
                <span class="text-xs text-gray-500">High/Low:</span>
                <span class="ml-1">${formatCurrency(
                  snapshot.high
                )}/${formatCurrency(snapshot.low)}</span>
              </div>
              <div>
                <span class="text-xs text-gray-500">Close:</span>
                <span class="ml-1">${formatCurrency(snapshot.close)}</span>
              </div>
              <div>
                <span class="text-xs text-gray-500">Volume:</span>
                <span class="ml-1">${
                  snapshot.volume
                    ? Number(snapshot.volume).toLocaleString()
                    : "-"
                }</span>
              </div>
              <div>
                <span class="text-xs text-gray-500">Halted:</span>
                <span class="ml-1">${snapshot.halted ? "Yes" : "No"}</span>
              </div>
            </div>
          </div>
          
          <!-- Trading Levels Panel -->
          <div class="bg-gray-900 p-3 rounded">
            <h5 class="text-sm text-gray-400 font-medium mb-2">Trading Levels</h5>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <span class="text-xs text-gray-500">vStop:</span>
                <span class="text-lg font-semibold ml-1 ${
                  SymbolInfo.uptrend ? "text-green-400" : "text-red-400"
                }">${formatCurrency(SymbolInfo.vStop)}</span>
              </div>
              <div>
                <span class="text-xs text-gray-500">Entry Price:</span>
                <span class="ml-1">${formatCurrency(
                  SymbolInfo.limit_price
                )}</span>
              </div>
              <div>
                <span class="text-xs text-gray-500">Stop Loss:</span>
                <span class="ml-1">${formatCurrency(SymbolInfo.stop_loss)}</span>
              </div>
              <div>
                <span class="text-xs text-gray-500">Timeframe:</span>
                <span class="ml-1">${SymbolInfo.barSizeSetting_web || "-"}</span>
              </div>
              <div>
                <span class="text-xs text-gray-500">Mark Price:</span>
                <span class="ml-1">${formatCurrency(snapshot.markPrice)}</span>
              </div>
              <div>
                <span class="text-xs text-gray-500">Shortable:</span>
                <span class="ml-1">${
                  snapshot.shortableShares ? "Yes" : "No"
                }</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mt-3 text-sm text-gray-400 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 ${statusColor}" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
          ${jsonData.message || "Market data updated"}
        </div>
      </div>
    `;

          contentContainer.html(contentHtml);
        } else {
          // Simple message if no snapshot data
          contentContainer.html(`
      <div class="p-4 bg-gray-800 rounded-md border border-gray-700 my-2">
        <div class="flex items-center mb-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 ${statusColor}" viewBox="0 0 24 24" fill="none" 
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 8v4"></path>
            <path d="M12 16h.01"></path>
          </svg>
          <span class="font-medium ${statusColor}">${
            jsonData.status || "Info"
          }</span>
        </div>
        <div class="ml-7 text-gray-300">${
          jsonData.message || jsonToHtml(jsonData)
        }</div>
      </div>
    `);
        }
      }
      async function subscribeSymbol() {
        const symbol = $("#symbol-search").val().trim();
        const barSizeSetting_web = $("#bar-size-setting").val(); // Get from dropdown

        if (!symbol) {
          showModalMessage("Error", {
            error: "Please enter a symbol symbol before subscribing.",
          });
          return;
        }

        try {
          const formData = getOrderFormData();
          const response = await fetch("/webapp-post-data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },

            body: JSON.stringify(formData),
          });
          const result = await response.json();
          showModalMessage("Subscribe Response", result);
        } catch (error) {
          console.error("Error subscribing to symbol:", error);
          showModalMessage("Error", {
            error: "Failed to subscribe to symbol.",
          });
        }
      }

      async function unsubscribeSymbol() {
        const symbol = $("#symbol-search").val().trim();
        if (!symbol) {
          showModalMessage("Error", {
            error: "Please enter a symbol symbol before unsubscribing.",
          });
          return;
        }
        try {
          const response = await fetch("/unsubscribe_from_symbol", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ symbol: symbol }),
          });
          const result = await response.json();
          showModalMessage("Unsubscribe Response", result);
        } catch (error) {
          console.error("Error unsubscribing from symbol:", error);
          showModalMessage("Error", {
            error: "Failed to unsubscribe from symbol.",
          });
        }
      }

      function formatTimeColumn(data, type, row) {
        return data ? moment(data).local().format("HH:mm:ss.SSS") : "";
      }

      async function unsubscribeSymbolButton(symbol) {
        if (!symbol) {
          showModalMessage("Error", {
            error: "Please enter a symbol symbol before unsubscribing.",
          });
          return;
        }
        try {
          const response = await fetch("/unsubscribe_from_symbol", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ symbol: symbol }),
          });
          const result = await response.json();
          showModalMessage("Unsubscribe Response", result);
        } catch (error) {
          console.error("Error unsubscribing from symbol:", error);
          showModalMessage("Error", {
            error: "Failed to unsubscribe from symbol.",
          });
        }
      }

      async function GetRvol() {
        try {
          const response = await fetch("/rvol?rvol=2", {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          });
          const result = await response.json();
          showModalMessage("Getting Rvol");
        } catch (error) {
          console.error("Error Getting Rvol:", error);
          showModalMessage("Error Getting Rvol", {
            error: "Failed to get rovl.",
          });
        }
      }

      async function getActiveSymbols() {
        try {
          console.log("Fetching active symbols...");

          // Fetch data using the existing fetchData function
          const response = await fetchData("/active-symbols");
          console.log("Raw active symbols response:", response);

          // FIX: Handle the response correctly - don't try to JSON.parse an object
          let activeSymbols = [];

          if (response && response.symbols) {
            // Check if symbols is already an object/array
            if (typeof response.symbols === "string") {
              try {
                activeSymbols = JSON.parse(response.symbols);
                console.log(
                  "Parsed symbols from JSON string:",
                  activeSymbols.length
                );
              } catch (parseError) {
                console.error("Failed to parse symbols JSON:", parseError);
                console.log("Raw symbols string:", response.symbols);
                activeSymbols = [];
              }
            } else if (Array.isArray(response.symbols)) {
              activeSymbols = response.symbols;
              console.log(
                "Using symbols array directly:",
                activeSymbols.length
              );
            } else if (typeof response.symbols === "object") {
              // If it's a single symbol object, wrap it in an array
              activeSymbols = [response.symbols];
              console.log("Converting single symbol object to array");
            } else {
              console.warn(
                "Unexpected symbols data type:",
                typeof response.symbols,
                response.symbols
              );
              activeSymbols = [];
            }
          } else {
            console.warn("No symbols property found in response:", response);
            activeSymbols = [];
          }

          console.log("Processed active symbols:", activeSymbols);

          // Helper function to safely render mid price
          function renderMid(data, type, row) {
            try {
              if (
                row.bid != null &&
                row.ask != null &&
                !isNaN(row.bid) &&
                !isNaN(row.ask)
              ) {
                return ((row.bid + row.ask) / 2).toFixed(2);
              }
              return "N/A";
            } catch (error) {
              console.error("Error calculating mid price:", error);
              return "N/A";
            }
          }

          // Safe currency formatting function
          const formatCurrencyForTable = (value) => {
            try {
              if (value === null || value === undefined || isNaN(value))
                return "N/A";
              return new Intl.NumberFormat("en-US", {
                style: "currency",
                currency: "USD",
                minimumFractionDigits: 2,
              }).format(value);
            } catch (error) {
              console.error("Error formatting currency:", error);
              return "N/A";
            }
          };

          // Safe time formatting function
          function formatTimeColumn(data, type, row) {
            try {
              if (!data) return "N/A";
              return moment(data).local().format("HH:mm:ss.SSS");
            } catch (error) {
              console.error("Error formatting time:", error);
              return "N/A";
            }
          }

          // Initialize or update the DataTable
          if ($.fn.DataTable.isDataTable("#symbol-table")) {
            $("#symbol-table").DataTable().destroy();
          }

          $("#symbol-table").DataTable({
            data: activeSymbols,
            columns: [
              {
                data: null,
                title: "Actions",
                orderable: false,
                render: function (data) {
                  try {
                    const symbol =
                      data.symbol || data.contract?.symbol || "Unknown";
                    return `<button onclick="unsubscribeSymbolButton('${symbol}')"
                      class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded text-white transition-colors">
                      Cancel
                    </button>`;
                  } catch (error) {
                    console.error("Error rendering unsubscribe button:", error);
                    return '<span class="text-gray-500">N/A</span>';
                  }
                },
              },
              {
                data: "symbol",
                title: "Symbol",
                render: function (data, type, row) {
                  // Try multiple possible paths for symbol
                  return data || row.contract?.symbol || "N/A";
                },
              },
              {
                data: "conId",
                title: "Contract ID",
                render: function (data, type, row) {
                  // Try multiple possible paths for conId
                  const conId = data || row.contract?.conId;
                  return conId ? conId.toString() : "N/A";
                },
              },
              {
                data: "last",
                title: "Last Price",
                render: function (data) {
                  return formatCurrencyForTable(data);
                },
              },
              {
                data: "close",
                title: "Close Price",
                render: function (data) {
                  return formatCurrencyForTable(data);
                },
              },
              {
                data: "bid",
                title: "Bid",
                render: function (data) {
                  return formatCurrencyForTable(data);
                },
              },
              {
                data: "ask",
                title: "Ask",
                render: function (data) {
                  return formatCurrencyForTable(data);
                },
              },
              {
                data: null,
                title: "Mid",
                render: renderMid,
              },
              {
                data: "time",
                title: "Last Update",
                render: formatTimeColumn,
              },
            ],
            order: [[1, "asc"]], // Sort by symbol
            pageLength: 25,
            dom: '<"flex flex-col sm:flex-row justify-between items-center"<"flex-1"l><"flex-1 text-right"f>>rtip',
            responsive: true,
            language: {
              search: "Filter symbols:",
              emptyTable: "No active symbols found",
              zeroRecords: "No matching symbols found",
            },
            drawCallback: function () {
              console.log(
                "Symbols table updated with",
                this.api().data().length,
                "rows"
              );
            },
          });

          console.log(
            "Successfully loaded",
            activeSymbols.length,
            "active symbols"
          );
        } catch (error) {
          console.error("Failed to load Symbol data:", error);
          showError("Could not load active symbols: " + error.message);

          // Initialize empty table on error
          if ($.fn.DataTable.isDataTable("#symbol-table")) {
            $("#symbol-table").DataTable().destroy();
          }

          $("#symbol-table").DataTable({
            data: [],
            columns: [
              {
                title: "Error loading symbols",
                data: null,
                defaultContent: "Please refresh the page",
              },
            ],
          });
        }
      }

      async function unsubscribeAllSymbol() {
        const table = $("#symbol-table").DataTable();
        const SymbolDataArr = table.data().toArray();
        if (SymbolDataArr.length === 0) {
          showModalMessage("Error", { error: "No symbols to unsubscribe." });
          return;
        }
        try {
          const unsubscribePromises = SymbolDataArr.map((symbol) =>
            fetch("/unsubscribe_from_symbol", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ symbol: symbol.symbol }),
            }).then((response) => response.json())
          );
          const results = await Promise.all(unsubscribePromises);
          showModalMessage("Unsubscribe All Response", {
            status: "success",
            results: results,
          });
        } catch (error) {
          console.error("Error unsubscribing all symbols:", error);
          showModalMessage("Error", {
            error: "Failed to unsubscribe all symbols.",
          });
        }
      }

      function initSymbolAutocomplete(selector) {
        const $input = $(selector);
        let debounceTimer = null;

        $input
          .autocomplete({
            minLength: 1,
            source(request, response) {
              const term = request.term.toUpperCase();

              clearTimeout(debounceTimer);
              debounceTimer = setTimeout(() => {
                const results = [];
                for (
                  let i = 0;
                  i < SymbolList.length && results.length < 10;
                  i++
                ) {
                  const sym = SymbolList[i];
                  if (sym.startsWith(term)) {
                    results.push({
                      label: `${sym} – ${SymbolMap[sym]}`,
                      value: sym,
                    });
                  }
                }
                response(results);
              }, 100);
            },
            select(_ev, ui) {
              $input.val(ui.item.value);
              return false;
            },
          })
          .autocomplete("instance")._renderItem = function (ul, item) {
          return $("<li>").append(`<div>${item.label}</div>`).appendTo(ul);
        };

        // keep typing uppercase, preserving cursor
        $input.on("input", () => {
          const pos = $input[0].selectionStart;
          $input.val($input.val().toUpperCase());
          $input[0].setSelectionRange(pos, pos);
        });
      }

      // ———— Helpers ———— market-order
      function initBracketOrderToggle() {
        const $cb = $("#take-profit-bracket");
        const $mkOrder = $("#market-order");
        $cb.on("change", () => {
          const checked = $cb.is(":checked");
          // keep value in sync
          $cb.val(checked);
          // tint the direction block
          $("#order-direction-block").css(
            "background-color",
            checked ? "#ae6df846" : ""
          );
        });
        $mkOrder.on("change", () => {
          const checkedmkOrder = $mkOrder.is(":checked");
          // keep value in sync
          $mkOrder.val(checkedmkOrder);
          // tint the direction block
          $("#order-direction-block").css(
            "background-color",
            checkedmkOrder ? "#ae6df846" : ""
          );
        });
      }

      function initOrderActionToggle() {
        const $buy = $("#buy-button"),
          $sell = $("#sell-button"),
          $submit = $("#submit-order-button"),
          $check = $("#check-order-button");

        $buy.add($sell).on("click", function () {
          const action = $(this).data("value");
          $("#order-action").val(action);

          if (action === "BUY") {
            $buy
              .addClass("bg-green-600 text-white")
              .removeClass("bg-gray-800 text-gray-400");
            $sell
              .addClass("bg-gray-800 text-gray-400")
              .removeClass("bg-red-600 text-white");
            $submit
              .text("Place Long Order")
              .removeClass("bg-red-600 hover:bg-red-700")
              .addClass("bg-green-600 hover:bg-green-700");
            $check.text("Check Long Parameters");
          } else {
            $sell
              .addClass("bg-red-600 text-white")
              .removeClass("bg-gray-800 text-gray-400");
            $buy
              .addClass("bg-gray-800 text-gray-400")
              .removeClass("bg-green-600 text-white");
            $submit
              .text("Place Short Order")
              .removeClass("bg-green-600 hover:bg-green-700")
              .addClass("bg-red-600 hover:bg-red-700");
            $check.text("Check Short Parameters");
          }
        });
      }

      function initStopTypeToggle() {
        const $buttons = $(".stop-type-button");
        $buttons.on("click", function () {
          const type = $(this).data("value");
          $("#stop-type").val(type);
          // style buttons
          $buttons
            .removeClass("bg-blue-600 text-white")
            .addClass("bg-gray-800 text-gray-400");
          $(this)
            .addClass("bg-blue-600 text-white")
            .removeClass("bg-gray-800 text-gray-400");

          // show/hide controls
          const isManual = type === "manual",
            showV = type === "vStop",
            showKC = type === "kcStop";

          $("#manual-stop-container").toggleClass("hidden", !isManual);
          $("#vstop-atr-factor-slider")
            .closest(".slider-container")
            .toggle(showV);
          $("#kc-atr-factor-slider")
            .closest(".slider-container")
            .toggle(showKC);
        });

        // on load: fire once
        $buttons.filter(`[data-value="${$("#stop-type").val()}"]`).click();
      }

      function initSliders() {
        $("#reward-risk-slider").slider({
          min: 0.5,
          max: 5,
          step: 0.1,
          value: 1,
          slide(_e, ui) {
            $("#reward-risk-display").text(ui.value.toFixed(1) + ":1");
            $("#reward-risk-ratio").val(ui.value.toFixed(1));
          },
        });
        $("#vstop-atr-factor-slider").slider({
          min: 0.5,
          max: 3,
          step: 0.1,
          value: 1.5,
          slide(_e, ui) {
            $("#vstop-atr-factor-display").text(ui.value.toFixed(1));
            $("#vstop-atr-factor").val(ui.value.toFixed(1));
          },
        });
        $("#kc-atr-factor-slider").slider({
          min: 1,
          max: 4,
          step: 0.1,
          value: 2,
          slide(_e, ui) {
            $("#kc-atr-factor-display").text(ui.value.toFixed(1));
            $("#kc-atr-factor").val(ui.value.toFixed(1));
          },
        });
        $("#risk-percentage-slider").slider({
          min: 0.1,
          max: 5,
          step: 0.1,
          value: 1,
          slide(_e, ui) {
            $("#risk-percentage-display").text(ui.value.toFixed(1) + "%");
            $("#risk-percentage").val(ui.value.toFixed(1));
          },
        });
      }

      function initButtons() {
        $("#subscribe-button").on("click", () => {
          const t = $("#symbol-search").val().trim();
          if (!t) return showModalMessage("error", "Enter a symbol first");
          subscribeSymbol();
          $("#symbol-status-container").html(
            `<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded-full">Subscribed</span>`
          );
          showModalMessage("success", `Subscribed to ${t}`);
        });
        $("#unsubscribe-button").on("click", () => {
          const t = $("#symbol-search").val().trim();
          if (!t) return showModalMessage("error", "Enter a symbol first");
          unsubscribeSymbol();
          $("#symbol-status-container").html(
            `<span class="text-xs bg-red-500 text-white px-2 py-1 rounded-full">Unsubscribed</span>`
          );
          showModalMessage("info", `Unsubscribed from ${t}`);
        });
        $("#get-rvol").on("click", () => {
          GetRvol();
          showModalMessage("success", "Requested RVOL");
        });
      }
      // Utility to gather order form data
      function getOrderFormData() {
        const data = {
          symbol: $("#symbol-search").val().trim(),
          barSizeSetting_web: $("#bar-size-setting").val(),
          limit_price: 0.0,
          atrFactor: 1.5,
          quantity: 0.0,
          orderAction: $("#order-action").val(),
          takeProfitBool: $("#take-profit-bracket").is(":checked"),
          accountBalance: parseFloat($("#account-balance").val()),
          rewardRiskRatio: parseFloat($("#reward-risk-ratio").val()),
          vstopAtrFactor: parseFloat($("#vstop-atr-factor").val()),
          kcAtrFactor: parseFloat($("#kc-atr-factor").val()),
          riskPercentage: parseFloat($("#risk-percentage").val()),
          stopType: $("#stop-type").val(),
          set_market_order: $("#market-order").is(":checked"),
          stop_loss: 0.0,
          uptrend: false,
          unixtime: Math.floor(Date.now() / 1000), // Current Unix timestamp in seconds
        };

        if (data.stopType === "manual") {
          data.stop_loss = parseFloat($("#manual-stop-loss").val());
        }
        return data;
      }

      $(document).ready(function () {
        // Check Order Parameters
        $("#check-order-button").on("click", async function (e) {
          e.preventDefault();
          const formData = getOrderFormData();
          try {
            const res = await fetch("/check_order", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formData),
            });
            const result = await res.json();
            showModalMessage("Check Order Result", result);
          } catch (err) {
            console.error("Error checking order:", err);
            showError("Failed to check order parameters");
          }
        });

        // Place Order
        $("#submit-order-button").on("click", async function (e) {
          e.preventDefault();
          const formData = getOrderFormData();
          try {
            const res = await fetch("/place_order", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formData),
            });
            const result = await res.json();
            showModalMessage("Place Order Result", result);
            loadDashboardData(); // refresh tables/metrics
          } catch (err) {
            console.error("Error placing order:", err);
            showError("Failed to place order");
          }
        });
      });

      // ———— Document Ready ————
      $(function () {
        initBracketOrderToggle();
        initOrderActionToggle();
        initStopTypeToggle();
        initSliders();
        initButtons();

        // If you have a jQuery UI buttonset for order-action:
        if ($("#order-action-container").length)
          $("#order-action-container").buttonset();
      });

      async function closeAllPositions() {
        // Get the button and show spinner
        const button = $("#closeAllBtn");
        button
          .prop("disabled", true)
          .html('<span class="spinner"></span> Closing...');

        try {
          // Get the DataTable instance and get all row data
          const table = $("#portfolio-table").DataTable();
          const positions = table.data().toArray();

          if (positions.length === 0) {
            showSuccess("No positions to close");
            button.prop("disabled", false).text("Close All Positions");
            return;
          }

          // Function to create a delay
          const delay = (ms) =>
            new Promise((resolve) => setTimeout(resolve, ms));

          // Process positions sequentially with delay
          const results = [];
          const totalPositions = positions.length;
          let completedCount = 0;

          // Show progress indicator
          showSuccess(`Closing ${totalPositions} positions...`);

          // Process each position one by one with a delay
          for (const pos of positions) {
            const symbol = pos.symbol;
            const position = pos.position;
            const price = pos.marketPrice;
            const direction = position > 0 ? "SELL" : "BUY";

           
            const positions = await fetchIbData().then(
              (data) => data.positions || []
            );
            const timestamp = Math.floor(Date.now() / 1000); // Current Unix timestamp in seconds

            const quantity =  pos.position;

            const orderAction = position > 0 ? "SELL" : "BUY";

            const barSizeSetting_web = $("#bar-size-setting").val();

            const requestBody = {
              symbol: symbol,
              barSizeSetting_web: barSizeSetting_web,
              limit_price: price,
              rewardRiskRatio: parseFloat($("#reward-risk-ratio").val()),
              atrFactor: 1.5, // Default value, can be adjusted
              vstopAtrFactor: parseFloat($("#vstop-atr-factor").val()),
              kcAtrFactor: parseFloat($("#kc-atr-factor").val()),
              riskPercentage: parseFloat($("#risk-percentage").val()),
              accountBalance: parseFloat($("#account-balance").val()),
              orderAction: "close_all",
              quantity: Math.abs(position),
              stopType: "vStop",
              takeProfitBool: $("#take-profit-bracket").val() === "true",
              set_market_order: $("#market-order").val() === "true",
              stop_loss: 0.0, // Default value, will be overridden for manual stop types
              uptrend: false, // Assuming uptrend is a boolean property in positions
            };

            try {
              // Update button with progress
              completedCount++;
              button.html(
                `<span class="spinner"></span> Closing ${completedCount}/${totalPositions}`
              );

              console.log(`Sending close request for ${symbol}`);
              const response = await fetch("/close_positions", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestBody),
              });

              if (!response.ok) {
                throw new Error(
                  `Failed to close ${symbol}: ${response.status}`
                );
              }

              results.push({ symbol, success: true });

              // Only add delay if there are more items to process
              if (completedCount < totalPositions) {
                await delay(200); // 200ms delay between requests
              }
            } catch (error) {
              console.error(`Error closing ${symbol}:`, error);
              results.push({ symbol, success: false, error });

              // Still add delay between requests even if one fails
              if (completedCount < totalPositions) {
                await delay(200);
              }
            }
          }

          // Count successes and failures
          const successes = results.filter((r) => r.success).length;
          const failures = results.filter((r) => !r.success).length;

          if (failures === 0) {
            showSuccess(`Successfully closed all ${successes} positions`);
          } else if (successes === 0) {
            showError(`Failed to close all positions`);
          } else {
            showSuccess(
              `Closed ${successes} positions successfully, ${failures} failed`
            );
          }

          // Refresh the data
          await loadDashboardData();
        } catch (error) {
          console.error("Error closing all positions:", error);
          showError("Failed to close all positions");
        } finally {
          button.prop("disabled", false).text("Close All Positions");
        }
      }
      function updateFormDataWithStopLoss(formData) {
        const stopType = $("#stop-type").val();

        if (stopType === "manual") {
          // Add manual stop loss value to form data
          const manualStopLoss = parseFloat($("#manual-stop-loss").val());
          if (!isNaN(manualStopLoss)) {
            formData.stop_loss = manualStopLoss.toFixed(2);
          } else {
            // If no value is provided, set a default or alert the user
            alert("Please enter a valid stop loss price.");
            throw new Error("Invalid stop loss price");
          }
        }

        return formData;
      }

      $(document).ready(function () {
        // Initialize the jQuery UI selectmenu
        $("#bar-size-setting")
          .selectmenu({
            width: "100%",
            classes: {
              "ui-selectmenu-button":
                "ui-corner-all bg-gray-900 border border-gray-700 text-gray-200",
              "ui-selectmenu-menu":
                "bg-gray-900 border border-gray-700 text-gray-200",
            },
          })
          .selectmenu("menuWidget")
          .addClass("bg-gray-800 text-gray-200");

        // Apply custom styling to the selectmenu
        $(".ui-selectmenu-button").css({
          "background-color": "#111827",
          "border-color": "#374151",
          color: "#E5E7EB",
          "border-radius": "0.5rem",
          padding: "0.5rem 1rem",
        });
      });
    </script>
  </body>
</html>
